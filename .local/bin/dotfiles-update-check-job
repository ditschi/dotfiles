#!/usr/bin/env bash
set -u

repo="${DOTFILES_REPO:-$HOME/dotfiles}"
marker="${DOTFILES_UPDATE_MARKER:-$HOME/.dotfiles-update-available}"
last_check_file="${DOTFILES_UPDATE_LAST_CHECK:-$HOME/.dotfiles-update-last-check}"

date -Is > "$last_check_file"

if [ ! -d "$repo/.git" ]; then
    exit 0
fi

if ! git -C "$repo" fetch --quiet; then
    exit 0
fi

branch="$(git -C "$repo" rev-parse --abbrev-ref HEAD 2>/dev/null || true)"
if [ -z "$branch" ]; then
    exit 0
fi

upstream_ref="origin/$branch"
if ! git -C "$repo" rev-parse --verify "$upstream_ref" >/dev/null 2>&1; then
    exit 0
fi

pending_count="$(git -C "$repo" rev-list --count "HEAD..$upstream_ref" 2>/dev/null || echo 0)"
if [ "${pending_count:-0}" -gt 0 ]; then
    : > "$marker"
else
    rm -f "$marker"
fi
